generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model event_attachments {
  id         Int       @id @default(autoincrement())
  event_id   Int
  file_name  String    @db.VarChar(500)
  file_data  Bytes
  file_size  Int
  mime_type  String?   @db.VarChar(255)
  created_at DateTime? @default(now()) @db.Timestamp(0)
  events     events    @relation(fields: [event_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_attachments_event")

  @@index([event_id], map: "idx_event_id")
}

model event_categories {
  id                  Int                   @id @default(autoincrement())
  name                String                @unique(map: "name") @db.VarChar(255)
  color               String                @default("#3B82F6") @db.VarChar(7)
  created_at          DateTime?             @default(now()) @db.Timestamp(0)
  updated_at          DateTime?             @default(now()) @db.Timestamp(0)
  event_subcategories event_subcategories[]
  events              events[]

  @@index([name], map: "idx_name")
}

model event_email_alert_logs {
  id            Int       @id @default(autoincrement())
  event_id      Int
  alert_date    DateTime  @db.Date
  email_sent_to String    @db.VarChar(255)
  sent_at       DateTime? @default(now()) @db.Timestamp(0)
  events        events    @relation(fields: [event_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_email_alert_event")

  @@unique([event_id, alert_date, email_sent_to], map: "uk_event_alert_email")
  @@index([alert_date], map: "idx_alert_date")
  @@index([event_id, alert_date], map: "idx_event_alert")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model event_history {
  id           Int                  @id @default(autoincrement())
  event_id     Int
  action       event_history_action
  performed_by Int?
  performed_at DateTime?            @default(now()) @db.Timestamp(0)
  summary      String?              @db.Text
  diff         Json?
  metadata     Json?
  events       events               @relation(fields: [event_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_event_history_event")
  users        users?               @relation(fields: [performed_by], references: [id], onUpdate: NoAction, map: "fk_event_history_user")

  @@index([performed_by], map: "fk_event_history_user")
  @@index([action], map: "idx_action")
  @@index([event_id], map: "idx_event_id")
  @@index([event_id, performed_at(sort: Desc)], map: "idx_event_performed")
  @@index([performed_at], map: "idx_performed_at")
}

model event_platforms {
  id         Int       @id @default(autoincrement())
  name       String    @unique(map: "name") @db.VarChar(255)
  color      String    @default("#3B82F6") @db.VarChar(7)
  created_at DateTime? @default(now()) @db.Timestamp(0)
  updated_at DateTime? @default(now()) @db.Timestamp(0)
  events     events[]

  @@index([name], map: "idx_name")
}

model event_subcategories {
  id               Int              @id @default(autoincrement())
  category_id      Int
  name             String           @db.VarChar(255)
  created_at       DateTime?        @default(now()) @db.Timestamp(0)
  updated_at       DateTime?        @default(now()) @db.Timestamp(0)
  event_categories event_categories @relation(fields: [category_id], references: [id], onDelete: Cascade, map: "fk_subcategories_category")
  events           events[]

  @@unique([category_id, name], map: "uk_category_name")
  @@index([category_id], map: "idx_category_id")
  @@index([name], map: "idx_name")
}

model event_tags {
  id         Int       @id @default(autoincrement())
  event_id   Int
  tag        String    @db.VarChar(100)
  created_at DateTime? @default(now()) @db.Timestamp(0)
  events     events    @relation(fields: [event_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_event_tags_event")

  @@unique([event_id, tag], map: "uk_event_tag")
  @@index([event_id], map: "idx_event_id")
  @@index([tag], map: "idx_tag")
  @@index([tag, event_id], map: "idx_tag_event")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model event_warning_settings {
  id           Int       @id
  red_days     Int       @default(0)
  orange_days  Int       @default(7)
  red_color    String    @default("#ef4444") @db.VarChar(7)
  orange_color String    @default("#f59e0b") @db.VarChar(7)
  green_color  String    @default("#22c55e") @db.VarChar(7)
  updated_at   DateTime? @default(now()) @db.Timestamp(0)
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model events {
  id                       Int                      @id @default(autoincrement())
  title                    String                   @db.VarChar(500)
  description              String?                  @db.Text
  location                 String?                  @db.VarChar(500)
  start                    DateTime?                @db.DateTime(0)
  end                      DateTime?                @db.DateTime(0)
  all_day                  Boolean?                 @default(false)
  category_id              Int?
  subcategory_id           Int?
  platform_id              Int?
  responsible_id           Int?
  repeat_type              events_repeat_type?      @default(none)
  repeat_end_date          DateTime?                @db.Date
  rrule                    String?                  @db.Text
  recurrence_id            DateTime?                @db.DateTime(0)
  exdate                   Json?
  alert_minutes            Int?
  email_alert_working_days Int?
  status                   String                   @default("Planifi√©") @db.VarChar(20)
  created_at               DateTime?                @default(now()) @db.Timestamp(0)
  updated_at               DateTime?                @default(now()) @db.Timestamp(0)
  event_attachments        event_attachments[]
  event_email_alert_logs   event_email_alert_logs[]
  event_history            event_history[]
  event_tags               event_tags[]
  event_categories         event_categories?        @relation(fields: [category_id], references: [id], map: "fk_events_category")
  event_platforms          event_platforms?         @relation(fields: [platform_id], references: [id], map: "fk_events_platform")
  users                    users?                   @relation(fields: [responsible_id], references: [id], map: "fk_events_responsible")
  event_subcategories      event_subcategories?     @relation(fields: [subcategory_id], references: [id], map: "fk_events_subcategory")
  task_status_history      task_status_history[]

  @@index([category_id], map: "idx_category_id")
  @@index([start, end], map: "idx_date_range")
  @@index([end], map: "idx_end")
  @@index([platform_id], map: "idx_platform_id")
  @@index([recurrence_id], map: "idx_recurrence_id")
  @@index([responsible_id], map: "idx_responsible_id")
  @@index([start], map: "idx_start")
  @@index([subcategory_id], map: "idx_subcategory_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model filter_preferences {
  id              Int       @id
  status_filter   Json?
  category_ids    Json?
  platform_ids    Json?
  responsible_ids Json?
  updated_at      DateTime? @default(now()) @db.Timestamp(0)
}

model permission_role_permissions {
  id               Int              @id @default(autoincrement())
  role_id          Int
  permission_type  String           @db.VarChar(50)
  has_permission   Boolean?         @default(false)
  created_at       DateTime?        @default(now()) @db.Timestamp(0)
  updated_at       DateTime?        @default(now()) @db.Timestamp(0)
  permission_roles permission_roles @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "permission_role_permissions_ibfk_1")

  @@unique([role_id, permission_type], map: "unique_role_permission")
  @@index([permission_type], map: "idx_permission_type")
  @@index([role_id], map: "idx_role_id")
}

model permission_roles {
  id                          Int                           @id @default(autoincrement())
  name                        String                        @unique(map: "name") @db.VarChar(255)
  description                 String?                       @db.Text
  color                       String                        @default("#3B82F6") @db.VarChar(7)
  created_at                  DateTime?                     @default(now()) @db.Timestamp(0)
  updated_at                  DateTime?                     @default(now()) @db.Timestamp(0)
  permission_role_permissions permission_role_permissions[]
  users                       users[]

  @@index([name], map: "idx_name")
}

model task_status_history {
  id         Int      @id @default(autoincrement())
  task_id    Int
  status     String   @db.VarChar(32)
  changed_at DateTime @default(now()) @db.Timestamp(0)
  events     events   @relation(fields: [task_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_task_status_history_event")

  @@index([changed_at], map: "idx_changed_at")
  @@index([task_id], map: "idx_task_id")
}

model user_filters {
  id              Int       @id @default(autoincrement())
  user_id         Int       @unique(map: "user_id")
  status_filter   Json?
  category_ids    Json?
  platform_ids    Json?
  responsible_ids Json?
  tag_filter      Json?
  created_at      DateTime? @default(now()) @db.Timestamp(0)
  updated_at      DateTime? @default(now()) @db.Timestamp(0)
  users           users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user_filters_user")

  @@index([user_id], map: "idx_user_id")
}

model user_settings {
  id                     Int       @id @default(autoincrement())
  user_id                Int       @unique(map: "user_id")
  logo_animation_enabled Boolean   @default(true)
  theme                  String    @default("glass") @db.VarChar(20)
  created_at             DateTime? @default(now()) @db.Timestamp(0)
  updated_at             DateTime? @default(now()) @db.Timestamp(0)
  users                  users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user_settings_user")

  @@index([user_id], map: "idx_user_id")
}

model users {
  id                   Int               @id @default(autoincrement())
  name                 String            @unique(map: "name") @db.VarChar(255)
  email                String?           @unique(map: "email") @db.VarChar(255)
  password_hash        String?           @db.VarChar(255)
  role                 users_role?       @default(user)
  is_active            Boolean?          @default(true)
  is_root_admin        Boolean           @default(false)
  must_change_password Boolean           @default(false)
  department           String?           @db.VarChar(255)
  last_login           DateTime?         @db.DateTime(0)
  custom_role_id       Int?
  created_at           DateTime?         @default(now()) @db.Timestamp(0)
  updated_at           DateTime?         @default(now()) @db.Timestamp(0)
  event_history        event_history[]
  events               events[]
  user_filters         user_filters?
  user_settings        user_settings?
  permission_roles     permission_roles? @relation(fields: [custom_role_id], references: [id], onUpdate: NoAction, map: "fk_user_permission_role")

  @@index([custom_role_id], map: "fk_user_permission_role")
  @@index([email], map: "idx_email")
  @@index([name], map: "idx_name")
}

enum event_history_action {
  created
  updated
  status_changed
  deleted
  attachment_added
  attachment_removed
}

enum users_role {
  user
  admin
}

enum events_repeat_type {
  none
  weekly
  monthly
  quarterly
  semestrial
  yearly
}
